---
title: "Manuscript 2: Gastric aspiration and the lung microbiome, right and left lungs"
output: 
  html_document:
    toc: true # table of content 
    toc_float:
      collapsed: true
      smooth_scroll: false
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---



```{r load_libraries, echo=FALSE, results='hide'}

source("analysis_functions.R")

## Load Libraries
suppressPackageStartupMessages(library("phyloseq"))
# suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("dplyr"))
# suppressPackageStartupMessages(library("vegan"))
# suppressPackageStartupMessages(library("stringr"))
# suppressPackageStartupMessages(library("tidyr"))
# suppressPackageStartupMessages(library("tibble"))
# suppressPackageStartupMessages(library("magrittr"))
# suppressPackageStartupMessages(library("stringr"))
# suppressPackageStartupMessages(library("tools"))

## Load Data
bacteria.ps = readRDS(file.path("workspace", "bacteria_ps.rds"))

## Setup Output
lefse_outdir = file.path("workspace","lefse_aspiration_left_right")
dir.create(lefse_outdir, showWarnings = FALSE)
```

```{r check_metadata, echo=FALSE, results='hide'}
# Figure out how to label plot
sample_data(bacteria.ps) %>% colnames() %>% paste(collapse = ",")

sample_data(bacteria.ps) %>% select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,lung,treated_lung,antibiotic_bool,aspiration_bool) %>% unique
```

# RIGHT lung PAIRED with LEFT lung from same animal (e.g. SLU1 paired with SRU1) 
## Part 1
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU1 through 12 (whole gastric fluid, group #1)
    + WRU1 through 12
    + ILU1 through 12 (irradiated gastric fluid)
    + IRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only including SRU group, then excluding SRU group
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only excluding SRU group
        + NMDS plot
        + LEfSe

### Right vs Left Lung
#### SLU vs SRU
```{r, echo=FALSE, results = 'asis'}
right_left1_SLU_SRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("SLU","SRU")))
right_left1_SLU_SRU.pruned.ps = PruneTaxa(right_left1_SLU_SRU.ps)

## Transform to even sampling depth.
right_left1_SLU_SRU.even.ps = TransformCounts(right_left1_SLU_SRU.pruned.ps)
```

##### NMDS
```{r, echo=FALSE, results='hide'}
right_left1_SLU_SRU.nmds.plot = NMDSPlot(right_left1_SLU_SRU.even.ps, grouping = "lung")
print(right_left1_SLU_SRU.nmds.plot)
```

##### Permanova
The ordination plot, suggest that aspiration with saline in the left lung does not significantly effect the microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_SLU_SRU.perm = RunPermanova(right_left1_SLU_SRU.even.ps, "lung")
right_left1_SLU_SRU.adonis = right_left1_SLU_SRU.perm$adonis
print(right_left1_SLU_SRU.adonis)

right_left1_SLU_SRU.beta.permute = right_left1_SLU_SRU.perm$beta
print(right_left1_SLU_SRU.beta.permute)
```

The permanova comparing left lung aspirated with saline to paired, unaspirated right lung does not find a significant difference (p-value of `r right_left1_SLU_SRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is also insignificant (p-value of
`r right_left1_SLU_SRU.beta.permute$tab$"Pr(>F)"[1]`). 

# HERE HERE HERE
#### LefSE: saline vs gastric
```{r left_lung3_SLU_WLU_generate_lefse, echo=FALSE, results='hide', eval=FALSE}
left_lung3_SLU_WLU_lefse.file = file.path(lefse_outdir,"left_lung3_SLU_WLU.tsv")
GenerateLefseOutput(left_lung3_SLU_WLU.pruned.ps, 
                    output_columns = c("sample_aspiration"),
                    outfile = left_lung3_SLU_WLU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = left_lung3_SLU_WLU_lefse.file)
```

```{bash, echo=FALSE, results='hide', eval=FALSE}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis', eval=FALSE}
ShowFigure(paste0(file_path_sans_ext(left_lung3_SLU_WLU_lefse.file), ".png"))
```



## Part 1: Aspiration with Saline,Gastric Fluid, and Irradiated Gastric Fluid


# NOT DONE YET -------------------------------------------------------------------

## Part 2
* Samples
    + WRU1 through 12 (whole gastric fluid, cohort #1)
    + WRU13 through 24 (whole gastric fluid, cohort #2)
* Analysis
    + NMDS plot
    + LEfSe 

## Part 3
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU13 through 24 (whole gastric fluid, cohort #2)
    + WRU13 through 24
    + ASWLU1 through 12 (whole gastric fluid plus antibiotics)
    + ASWRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, SRU and WRU groups
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, WRU and ASWRU groups
        + NMDS plot
        + LEfSe
        
        
# Appendix


### Test ShowFigure
```{r, echo=FALSE, include=FALSE, results = 'asis'}
ShowFigure(file.path(lefse_outdir,"no_dummy.png"))

# ShowFigure(file.path(lefse_outdir,"dummy_file.png"),dummy_figure=TRUE)
```
