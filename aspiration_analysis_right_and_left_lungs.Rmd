---
title: "Manuscript 2: Gastric aspiration and the lung microbiome, right and left lungs"
output: 
  html_document:
    toc: true # table of content 
    toc_float:
      collapsed: true
      smooth_scroll: false
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---



```{r load_libraries, echo=FALSE, results='hide'}

source("analysis_functions.R")

## Load Libraries
suppressPackageStartupMessages(library("phyloseq"))
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("dplyr"))
# suppressPackageStartupMessages(library("vegan"))
# suppressPackageStartupMessages(library("stringr"))
# suppressPackageStartupMessages(library("tidyr"))
# suppressPackageStartupMessages(library("tibble"))
# suppressPackageStartupMessages(library("magrittr"))
# suppressPackageStartupMessages(library("stringr"))
suppressPackageStartupMessages(library("tools"))

## Load Data
bacteria.ps = readRDS(file.path("workspace", "bacteria_ps.rds"))

## Setup Output
lefse_outdir = file.path("workspace","lefse_aspiration_left_right")
dir.create(lefse_outdir, showWarnings = FALSE)
```

```{r check_metadata, echo=FALSE, results='hide'}
# Figure out how to label plot
sample_data(bacteria.ps) %>% colnames() %>% paste(collapse = ",")

sample_data(bacteria.ps) %>% select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,lung,treated_lung,antibiotic_bool,aspiration_bool) %>% unique

sample_data(bacteria.ps) %>% 
  select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,
         lung,treated_lung,antibiotic_bool,aspiration_bool) %>% 
  unique %>%
  filter(lung=="right")
```

# RIGHT lung PAIRED with LEFT lung from same animal (e.g. SLU1 paired with SRU1) 
## Part 1
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU1 through 12 (whole gastric fluid, group #1)
    + WRU1 through 12
    + ILU1 through 12 (irradiated gastric fluid)
    + IRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only including SRU group, then excluding SRU group
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only excluding SRU group
        + NMDS plot
        + LEfSe

> Why are we excluding cohort #2 of WLU and WRU here?

### Right vs Left Lung
#### SLU vs SRU
```{r, echo=FALSE, results = 'asis'}
right_left1_SLU_SRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("SLU","SRU")))
right_left1_SLU_SRU.pruned.ps = PruneTaxa(right_left1_SLU_SRU.ps)

## Transform to even sampling depth.
right_left1_SLU_SRU.even.ps = TransformCounts(right_left1_SLU_SRU.pruned.ps)
group_var = "group"
```

##### NMDS
```{r, echo=FALSE, results='hide'}
right_left1_SLU_SRU.nmds.plot = NMDSPlot(right_left1_SLU_SRU.even.ps, grouping = group_var)
print(right_left1_SLU_SRU.nmds.plot)
```

##### Permanova
The ordination plot, suggest that aspiration with saline in the left lung does not significantly effect the microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_SLU_SRU.perm = RunPermanova(right_left1_SLU_SRU.even.ps, group_var)
right_left1_SLU_SRU.adonis = right_left1_SLU_SRU.perm$adonis
print(right_left1_SLU_SRU.adonis)

right_left1_SLU_SRU.beta.permute = right_left1_SLU_SRU.perm$beta
print(right_left1_SLU_SRU.beta.permute)
```

The permanova comparing left lung aspirated with saline to paired, unaspirated right lung does not find a significant difference (p-value of `r right_left1_SLU_SRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is also insignificant (p-value of
`r right_left1_SLU_SRU.beta.permute$tab$"Pr(>F)"[1]`). 


#### WLU vs WRU, group1
```{r, echo=FALSE, results = 'asis'}
right_left1_WLU_WRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("WLU","WRU"))
                               & (animal <= 12))

right_left1_WLU_WRU.pruned.ps = PruneTaxa(right_left1_WLU_WRU.ps)

## Transform to even sampling depth.
right_left1_WLU_WRU.even.ps = TransformCounts(right_left1_WLU_WRU.pruned.ps)
group_var = "group"
```
```{r, echo=FALSE, results='hide'}
sample_data(right_left1_WLU_WRU.ps)
```

```{r, echo=FALSE, results='hide'}
right_left1_WLU_WRU.nmds.plot = NMDSPlot(right_left1_WLU_WRU.even.ps, grouping = group_var)
print(right_left1_WLU_WRU.nmds.plot)
```


##### Permanova
The ordination plot, suggest that aspiration with whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_WLU_WRU.perm = RunPermanova(right_left1_WLU_WRU.even.ps, group_var)
right_left1_WLU_WRU.adonis = right_left1_WLU_WRU.perm$adonis
print(right_left1_WLU_WRU.adonis)

right_left1_WLU_WRU.beta.permute = right_left1_WLU_WRU.perm$beta
print(right_left1_WLU_WRU.beta.permute)
```

The permanova comparing left lung aspirated with whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right_left1_WLU_WRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left1_WLU_WRU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

##### LefSE
```{r right_left1_WLU_WRU_generate_lefse, echo=FALSE, results='hide'}
right_left1_WLU_WRU_lefse.file = file.path(lefse_outdir,"right_left1_WLU_WRU.tsv")
GenerateLefseOutput(right_left1_WLU_WRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right_left1_WLU_WRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left1_WLU_WRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis'}
ShowFigure(paste0(file_path_sans_ext(right_left1_WLU_WRU_lefse.file), ".png"))
```

#### ILU vs IRU
```{r, echo=FALSE, results = 'asis'}
right_left1_ILU_IRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("ILU","IRU")))
right_left1_ILU_IRU.pruned.ps = PruneTaxa(right_left1_ILU_IRU.ps)

## Transform to even sampling depth.
right_left1_ILU_IRU.even.ps = TransformCounts(right_left1_ILU_IRU.pruned.ps)
group_var = "group"
```

```{r, echo=FALSE, results='hide'}
right_left1_ILU_IRU.nmds.plot = NMDSPlot(right_left1_ILU_IRU.even.ps, grouping = group_var)
print(right_left1_ILU_IRU.nmds.plot)
```


##### Permanova
The ordination plot suggest that aspiration with irradiated whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_ILU_IRU.perm = RunPermanova(right_left1_ILU_IRU.even.ps, group_var)
right_left1_ILU_IRU.adonis = right_left1_ILU_IRU.perm$adonis
print(right_left1_ILU_IRU.adonis)

right_left1_ILU_IRU.beta.permute = right_left1_ILU_IRU.perm$beta
print(right_left1_ILU_IRU.beta.permute)
```

The permanova comparing left lung aspirated with irradiated whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right_left1_ILU_IRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left1_ILU_IRU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

##### LefSE
```{r right_left1_ILU_IRU_generate_lefse, echo=FALSE, results='hide'}
right_left1_ILU_IRU_lefse.file = file.path(lefse_outdir,"right_left1_ILU_IRU.tsv")
GenerateLefseOutput(right_left1_ILU_IRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right_left1_ILU_IRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left1_ILU_IRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis', eval=FALSE}
ShowFigure(paste0(file_path_sans_ext(right_left1_ILU_IRU_lefse.file), ".png"))
```
Despite a significant permanova, LefSE does not find any taxa that are significantly different between the left lung aspirated with irradiated whole gastric fluid and the unaspirated right lung.

#### ASWLU vs ASWRU
```{r, echo=FALSE, results = 'asis'}
right_left1_ASWLU_ASWRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("ASWLU","ASWRU")))
right_left1_ASWLU_ASWRU.pruned.ps = PruneTaxa(right_left1_ASWLU_ASWRU.ps)

## Transform to even sampling depth.
right_left1_ASWLU_ASWRU.even.ps = TransformCounts(right_left1_ASWLU_ASWRU.pruned.ps)
group_var = "group"
```

```{r, echo=FALSE, results='hide'}
right_left1_ASWLU_ASWRU.nmds.plot = NMDSPlot(right_left1_ASWLU_ASWRU.even.ps, grouping = group_var)
print(right_left1_ASWLU_ASWRU.nmds.plot)
```


##### Permanova
The ordination plot suggest that aspiration with irradiated whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_ASWLU_ASWRU.perm = RunPermanova(right_left1_ASWLU_ASWRU.even.ps, group_var)
right_left1_ASWLU_ASWRU.adonis = right_left1_ASWLU_ASWRU.perm$adonis
print(right_left1_ASWLU_ASWRU.adonis)

right_left1_ASWLU_ASWRU.beta.permute = right_left1_ASWLU_ASWRU.perm$beta
print(right_left1_ASWLU_ASWRU.beta.permute)
```

The permanova comparing left lung aspirated with irradiated whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right_left1_ASWLU_ASWRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left1_ASWLU_ASWRU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

##### LefSE
```{r right_left1_ASWLU_ASWRU_generate_lefse, echo=FALSE, results='hide', eval=FALSE}
right_left1_ASWLU_ASWRU_lefse.file = file.path(lefse_outdir,"right_left1_ASWLU_ASWRU.tsv")
GenerateLefseOutput(right_left1_ASWLU_ASWRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right_left1_ASWLU_ASWRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left1_ASWLU_ASWRU_lefse.file)
```

```{bash, echo=FALSE, results='hide', eval=FALSE}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis', eval=FALSE}
ShowFigure(paste0(file_path_sans_ext(right_left1_ASWLU_ASWRU_lefse.file), ".png"))
```
Despite a significant permanova, LefSE does not find any taxa that are significantly different between the left lung aspirated with  whole gastric fluid and the unaspirated right lung in antibiotic treated animals


# HERE HERE HERE
### IRU
```{r, echo=FALSE, results = 'asis'}
IRU.ps = subset_samples(bacteria.ps,
                                    (group %in% c("IRU")) 
                                    & (animal <= 12))

IRU.pruned.ps = PruneTaxa(IRU.ps)

## Transform to even sampling depth.
IRU.even.ps = TransformCounts(IRU.pruned.ps)
group_var = "group"
```


```{r, echo=FALSE, results='hide'}
IRU.ps.rel  = transform_sample_counts(IRU.ps, function(x) x / sum(x) )
IRU.ps.rel.filt = filter_taxa(IRU.ps.rel, function(x) var(x) > 1e-5, TRUE)

IRU.rel.plot = ggplot(psmelt(IRU.ps.rel.filt), 
           aes_string(x = "animal", y = "Abundance", fill = "Genus")) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(~group) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
  theme(legend.key.size = unit(0.5, "cm"))
  # guides(fill=guide_legend(ncol=2))
print(IRU.rel.plot)
```

#### NMDS
```{r, echo=FALSE, results='hide'}
IRU.nmds.plot = NMDSPlot(IRU.even.ps, grouping = group_var)
print(IRU.nmds.plot +geom_text(aes(label=animal),hjust=0, vjust=0))
```

### Right Lung Only, with Saline
```{r, echo=FALSE, results = 'asis'}
right1_with_SRU.ps = subset_samples(bacteria.ps,
                                    (group %in% c("SRU", "WRU", "IRU")) 
                                    & (animal <= 12))

right1_with_SRU.pruned.ps = PruneTaxa(right1_with_SRU.ps)

## Transform to even sampling depth.
right1_with_SRU.even.ps = TransformCounts(right1_with_SRU.pruned.ps)
group_var = "group"
```
#### NMDS
```{r, echo=FALSE, results='hide'}
right1_with_SRU.nmds.plot = NMDSPlot(right1_with_SRU.even.ps, grouping = group_var)
print(right1_with_SRU.nmds.plot +geom_text(aes(label=animal),hjust=0, vjust=0))
```
IRU #8 appears to be an outlier, lets check it out!


```{r, echo=FALSE, results='hide'}
right1_with_SRU.ps.rel  = transform_sample_counts(right1_with_SRU.ps, function(x) x / sum(x) )
right1_with_SRU.ps.rel.filt = filter_taxa(right1_with_SRU.ps.rel, function(x) var(x) > 1e-4, TRUE)

right1_with_SRU.rel.plot = ggplot(psmelt(right1_with_SRU.ps.rel.filt), 
           aes_string(x = "animal", y = "Abundance", fill = "Genus")) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(~group) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
  theme(legend.key.size = unit(0.5, "cm")) +
  ylab("Relative Abundance")
  # guides(fill=guide_legend(ncol=2))
print(right1_with_SRU.rel.plot)
```
IRU #8 looks like an outlier by relative abundance.



```{r, echo=FALSE, results='hide'}

right1_with_SRU.plot = ggplot(psmelt(right1_with_SRU.ps), 
           aes_string(x = "animal", y = "Abundance", fill = "Genus")) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(~group) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
  theme(legend.key.size = unit(0.5, "cm")) + 
  guides(fill=FALSE) + 
  ylab("Raw Bacterial Counts")
  # guides(fill=guide_legend(ncol=2))
print(right1_with_SRU.plot )
```
Interestingly, IRU #8 also looks like an outlier by total counts - more than any of the other right lung samples.  It's not clear what is going on with IRU #8, so the simplest thing to do is exclude it and move on . . .

### Right Lung, no Antibiotics, with Saline, excluding IRU #8 (SRU, WRU, IRU)

```{r, echo=FALSE, results = 'asis'}
right1_with_SRU.ps = subset_samples(bacteria.ps,
                                    ((group %in% c("SRU", "WRU")) 
                                    & (animal <= 12)) |
                                     (group == "IRU" & (animal <= 12) & (animal != 8)) )

right1_with_SRU.pruned.ps = PruneTaxa(right1_with_SRU.ps)

## Transform to even sampling depth.
right1_with_SRU.even.ps = TransformCounts(right1_with_SRU.pruned.ps)
group_var = "group"
```

```{r, echo=FALSE, results='hide'}
sample_data(right1_with_SRU.ps)
```

#### NMDS
```{r, echo=FALSE, results='hide'}
right1_with_SRU.nmds.plot = NMDSPlot(right1_with_SRU.even.ps, grouping = group_var)
print(right1_with_SRU.nmds.plot)
```

#### Permanova
The ordination plot, suggest that aspiration with whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right1_with_SRU.perm = RunPermanova(right1_with_SRU.even.ps, group_var)
right1_with_SRU.adonis = right1_with_SRU.perm$adonis
print(right1_with_SRU.adonis)

right1_with_SRU.beta.permute = right1_with_SRU.perm$beta
print(right1_with_SRU.beta.permute)
```

The permanova comparing left lung aspirated with whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right1_with_SRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right1_with_SRU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

#### LefSE
```{r right1_with_SRU_generate_lefse, echo=FALSE, results='hide'}
right1_with_SRU_lefse.file = file.path(lefse_outdir,"right1_with_SRU.tsv")
GenerateLefseOutput(right1_with_SRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right1_with_SRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right1_with_SRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis'}
ShowFigure(paste0(file_path_sans_ext(right1_with_SRU_lefse.file), ".png"))
```

## Part 1: Aspiration with Saline,Gastric Fluid, and Irradiated Gastric Fluid


# NOT DONE YET -------------------------------------------------------------------

## Part 2
* Samples
    + WRU1 through 12 (whole gastric fluid, cohort #1)
    + WRU13 through 24 (whole gastric fluid, cohort #2)
* Analysis
    + NMDS plot
    + LEfSe 

## Part 3
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU13 through 24 (whole gastric fluid, cohort #2)
    + WRU13 through 24
    + ASWLU1 through 12 (whole gastric fluid plus antibiotics)
    + ASWRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, SRU and WRU groups
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, WRU and ASWRU groups
        + NMDS plot
        + LEfSe
        
        
# Appendix

## All Lefse Plots
LefSE has the capacity to generate a lot of plots.  I have incorporated the ones that I think are most relevant above, but am including the full set here to give a different perspective on the data, and in case you want more information about any of them.
```{r show_all_pngs, echo=FALSE, results = 'asis'}

for (cur_png in list.files(lefse_outdir, pattern = ".png$",recursive = TRUE,full.names = TRUE)){
  cat(paste0(cur_png,"\n\n\n"))
  ShowFigure(cur_png)
}
```

### Test ShowFigure
```{r, echo=FALSE, include=FALSE, results = 'asis'}
ShowFigure(file.path(lefse_outdir,"no_dummy.png"))

# ShowFigure(file.path(lefse_outdir,"dummy_file.png"),dummy_figure=TRUE)
```
