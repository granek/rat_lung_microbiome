---
title: "Manuscript 2: Gastric aspiration and the lung microbiome, right and left lungs"
output: 
  html_document:
    toc: true # table of content 
    toc_float:
      collapsed: true
      smooth_scroll: false
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---



```{r load_libraries, echo=FALSE, results='hide'}

source("analysis_functions.R")

## Load Libraries
suppressPackageStartupMessages(library("phyloseq"))
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("dplyr"))
# suppressPackageStartupMessages(library("vegan"))
# suppressPackageStartupMessages(library("stringr"))
# suppressPackageStartupMessages(library("tidyr"))
# suppressPackageStartupMessages(library("tibble"))
suppressPackageStartupMessages(library("magrittr"))
# suppressPackageStartupMessages(library("stringr"))
suppressPackageStartupMessages(library("tools"))

## Load Data
bacteria.ps = readRDS(file.path("workspace", "bacteria_ps.rds"))

## Setup Output
lefse_outdir = file.path("workspace","lefse_aspiration_left_right")
dir.create(lefse_outdir, showWarnings = FALSE)
```

```{r check_metadata, echo=FALSE, results='hide', eval=FALSE}
# Figure out how to label plot
sample_data(bacteria.ps) %>% colnames() %>% paste(collapse = ",")

sample_data(bacteria.ps) %>% select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,lung,treated_lung,antibiotic_bool,aspiration_bool) %>% unique

sample_data(bacteria.ps) %>% 
  select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,
         lung,treated_lung,antibiotic_bool,aspiration_bool) %>% 
  unique %>%
  filter(lung=="right")
```

# RIGHT lung Analyses
## Part 1
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU1 through 12 (whole gastric fluid, group #1)
    + WRU1 through 12
    + ILU1 through 12 (irradiated gastric fluid)
    + IRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only including SRU group, then excluding SRU group
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only excluding SRU group
        + NMDS plot
        + LEfSe

> Why are we excluding cohort #2 of WLU and WRU here?

### Right vs Left Lung
#### SLU vs SRU
```{r, echo=FALSE, results = 'asis'}
right_left1_SLU_SRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("SLU","SRU")))
right_left1_SLU_SRU.pruned.ps = PruneTaxa(right_left1_SLU_SRU.ps)

## Transform to even sampling depth.
right_left1_SLU_SRU.even.ps = TransformCounts(right_left1_SLU_SRU.pruned.ps)
group_var = "group"
```

##### NMDS
```{r, echo=FALSE, results='hide'}
right_left1_SLU_SRU.nmds.plot = NMDSPlot(right_left1_SLU_SRU.even.ps, grouping = group_var)
print(right_left1_SLU_SRU.nmds.plot)
```

##### Permanova
The ordination plot, suggest that aspiration with saline in the left lung does not significantly effect the microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_SLU_SRU.perm = RunPermanova(right_left1_SLU_SRU.even.ps, group_var)
right_left1_SLU_SRU.adonis = right_left1_SLU_SRU.perm$adonis
print(right_left1_SLU_SRU.adonis)

right_left1_SLU_SRU.beta.permute = right_left1_SLU_SRU.perm$beta
print(right_left1_SLU_SRU.beta.permute)
```

The permanova comparing left lung aspirated with saline to unaspirated right lung does not find a significant difference (p-value of `r right_left1_SLU_SRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is also insignificant (p-value of
`r right_left1_SLU_SRU.beta.permute$tab$"Pr(>F)"[1]`). 


#### WLU vs WRU, cohort #1
```{r, echo=FALSE, results = 'asis'}
right_left1_WLU_WRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("WLU","WRU"))
                               & (animal <= 12))

right_left1_WLU_WRU.pruned.ps = PruneTaxa(right_left1_WLU_WRU.ps)

## Transform to even sampling depth.
right_left1_WLU_WRU.even.ps = TransformCounts(right_left1_WLU_WRU.pruned.ps)
group_var = "group"
```
```{r, echo=FALSE, results='hide'}
sample_data(right_left1_WLU_WRU.ps)
```

```{r, echo=FALSE, results='hide'}
right_left1_WLU_WRU.nmds.plot = NMDSPlot(right_left1_WLU_WRU.even.ps, grouping = group_var)
print(right_left1_WLU_WRU.nmds.plot)
```


##### Permanova
The ordination plot, suggest that aspiration with whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_WLU_WRU.perm = RunPermanova(right_left1_WLU_WRU.even.ps, group_var)
right_left1_WLU_WRU.adonis = right_left1_WLU_WRU.perm$adonis
print(right_left1_WLU_WRU.adonis)

right_left1_WLU_WRU.beta.permute = right_left1_WLU_WRU.perm$beta
print(right_left1_WLU_WRU.beta.permute)
```

The permanova comparing left lung aspirated with whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right_left1_WLU_WRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left1_WLU_WRU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

##### LefSE
```{r right_left1_WLU_WRU_generate_lefse, echo=FALSE, results='hide'}
right_left1_WLU_WRU_lefse.file = file.path(lefse_outdir,"right_left1_WLU_WRU.tsv")
GenerateLefseOutput(right_left1_WLU_WRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right_left1_WLU_WRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left1_WLU_WRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis'}
ShowFigure(paste0(file_path_sans_ext(right_left1_WLU_WRU_lefse.file), ".png"))
```

LefSE identifies a few taxa with significantly differential abundance between left lung aspirated with whole gastric fluid to unaspirated right lung from the same animal.

#### ILU vs IRU
```{r, echo=FALSE, results = 'asis'}
right_left1_ILU_IRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("ILU","IRU")))
right_left1_ILU_IRU.pruned.ps = PruneTaxa(right_left1_ILU_IRU.ps)

## Transform to even sampling depth.
right_left1_ILU_IRU.even.ps = TransformCounts(right_left1_ILU_IRU.pruned.ps)
group_var = "group"
```

```{r, echo=FALSE, results='hide'}
right_left1_ILU_IRU.nmds.plot = NMDSPlot(right_left1_ILU_IRU.even.ps, grouping = group_var)
print(right_left1_ILU_IRU.nmds.plot)
```


##### Permanova
The ordination plot suggest that aspiration with irradiated whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_ILU_IRU.perm = RunPermanova(right_left1_ILU_IRU.even.ps, group_var)
right_left1_ILU_IRU.adonis = right_left1_ILU_IRU.perm$adonis
print(right_left1_ILU_IRU.adonis)

right_left1_ILU_IRU.beta.permute = right_left1_ILU_IRU.perm$beta
print(right_left1_ILU_IRU.beta.permute)
```

The permanova comparing left lung aspirated with irradiated whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right_left1_ILU_IRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left1_ILU_IRU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

##### LefSE
```{r right_left1_ILU_IRU_generate_lefse, echo=FALSE, results='hide'}
right_left1_ILU_IRU_lefse.file = file.path(lefse_outdir,"right_left1_ILU_IRU.tsv")
GenerateLefseOutput(right_left1_ILU_IRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right_left1_ILU_IRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left1_ILU_IRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis', eval=FALSE}
ShowFigure(paste0(file_path_sans_ext(right_left1_ILU_IRU_lefse.file), ".png"))
```
Despite a significant permanova, LefSE does not find any taxa that are significantly different between the left lung aspirated with irradiated whole gastric fluid and the unaspirated right lung.
<!---
Confirmed: No differentially abundant features found in workspace/lefse_aspiration_left_right/right_left1_ILU_IRU.res
-->


### Right Lung, no Antibiotics, with Saline (SRU, WRU, IRU)
```{r, echo=FALSE, results = 'asis'}
right1_with_SRU.ps = subset_samples(bacteria.ps,
                                    (group %in% c("SRU", "WRU", "IRU")) 
                                    & (animal <= 12))

right1_with_SRU.pruned.ps = PruneTaxa(right1_with_SRU.ps)

## Transform to even sampling depth.
right1_with_SRU.even.ps = TransformCounts(right1_with_SRU.pruned.ps)
group_var = "group"
```

#### NMDS
```{r, echo=FALSE, results='hide'}
right1_with_SRU.nmds.plot = NMDSPlot(right1_with_SRU.even.ps, grouping = group_var)
print(right1_with_SRU.nmds.plot +geom_text(aes(label=animal),hjust=0, vjust=0))
```

IRU #8 appears to be an outlier, which is dominating the ordination.  Lets examine it more closely!

```{r, echo=FALSE, results='hide'}
right1_with_SRU.ps.rel  = transform_sample_counts(right1_with_SRU.ps, function(x) x / sum(x) )
right1_with_SRU.ps.rel.filt = filter_taxa(right1_with_SRU.ps.rel, function(x) var(x) > 1e-4, TRUE)

right1_with_SRU.rel.plot = ggplot(psmelt(right1_with_SRU.ps.rel.filt), 
           aes_string(x = "animal", y = "Abundance", fill = "Genus")) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(~group) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
  theme(legend.key.size = unit(0.5, "cm")) +
  ylab("Relative Abundance")
  # guides(fill=guide_legend(ncol=2))
print(right1_with_SRU.rel.plot)
```

IRU #8 looks like an outlier by relative abundance: it is composed mostly of taxa which are absent or low  abundance in other samples.

```{r, echo=FALSE, results='hide'}

right1_with_SRU.plot = ggplot(psmelt(right1_with_SRU.ps), 
           aes_string(x = "animal", y = "Abundance", fill = "Genus")) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(~group) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
  theme(legend.key.size = unit(0.5, "cm")) + 
  guides(fill=FALSE) + 
  ylab("Raw Bacterial Counts")
  # guides(fill=guide_legend(ncol=2))
print(right1_with_SRU.plot )
```

IRU #8 also looks like an outlier by total counts, but interestingly it has _more counts_ than any of the other right lung samples.  It's not clear what is going on with IRU #8, so the simplest thing to do is exclude it and move on . . .

### Right Lung, no Antibiotics, with Saline (SRU, WRU, IRU), excluding IRU #8 

```{r, echo=FALSE, results = 'asis'}
right1_with_SRU.ps = subset_samples(bacteria.ps,
                                    ((group %in% c("SRU", "WRU")) 
                                    & (animal <= 12)) |
                                     (group == "IRU" & (animal <= 12) & (animal != 8)) )

right1_with_SRU.pruned.ps = PruneTaxa(right1_with_SRU.ps)

## Transform to even sampling depth.
right1_with_SRU.even.ps = TransformCounts(right1_with_SRU.pruned.ps)
group_var = "group"
```

```{r, echo=FALSE, results='hide'}
sample_data(right1_with_SRU.ps)
```

#### NMDS
```{r, echo=FALSE, results='hide'}
right1_with_SRU.nmds.plot = NMDSPlot(right1_with_SRU.even.ps, grouping = group_var)
print(right1_with_SRU.nmds.plot)
```

#### Permanova
There does seem to be some weak clustering of SRU, although this could just be lower dispersion. A permanova analysis will allows us to quantify this. 

```{r, echo=FALSE}
right1_with_SRU.perm = RunPermanova(right1_with_SRU.even.ps, group_var)
right1_with_SRU.adonis = right1_with_SRU.perm$adonis
print(right1_with_SRU.adonis)

right1_with_SRU.beta.permute = right1_with_SRU.perm$beta
print(right1_with_SRU.beta.permute)
```

The permanova comparing right lung samples by aspiration does not have a significant difference (p-value of `r right1_with_SRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is also insignificant (p-value of
`r right1_with_SRU.beta.permute$tab$"Pr(>F)"[1]`).

#### LefSE
```{r right1_with_SRU_generate_lefse, echo=FALSE, results='hide'}
right1_with_SRU_lefse.file = file.path(lefse_outdir,"right1_with_SRU.tsv")
GenerateLefseOutput(right1_with_SRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right1_with_SRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right1_with_SRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis',eval=FALSE}
ShowFigure(paste0(file_path_sans_ext(right1_with_SRU_lefse.file), ".png"))
```
As expect for a non-significant permanova, LefSE does not find any taxa that show significantly different abundance.

<!---
Confirmed: No differentially abundant features found in workspace/lefse_aspiration_left_right/right1_with_SRU.res
-->

### Right Lung, no Antibiotics, no Saline (WRU, IRU), excluding IRU #8

```{r, echo=FALSE, results = 'asis'}
right1_noSRU.ps = subset_samples(bacteria.ps,
                                    ((group %in% c("WRU")) 
                                    & (animal <= 12)) |
                                     (group == "IRU" & (animal <= 12) & (animal != 8)) )

right1_noSRU.pruned.ps = PruneTaxa(right1_noSRU.ps)

## Transform to even sampling depth.
right1_noSRU.even.ps = TransformCounts(right1_noSRU.pruned.ps)
group_var = "group"
```

```{r, echo=FALSE, results='hide'}
sample_data(right1_noSRU.ps)
```

#### NMDS
```{r, echo=FALSE, results='hide'}
right1_noSRU.nmds.plot = NMDSPlot(right1_noSRU.even.ps, grouping = group_var)
print(right1_noSRU.nmds.plot)
```

#### Permanova
The ordination plot does not seem to show any treatment differences, but we will test with a permanova analysis. 

```{r, echo=FALSE}
right1_noSRU.perm = RunPermanova(right1_noSRU.even.ps, group_var)
right1_noSRU.adonis = right1_noSRU.perm$adonis
print(right1_noSRU.adonis)

right1_noSRU.beta.permute = right1_noSRU.perm$beta
print(right1_noSRU.beta.permute)
```

The permanova comparing right lung samples by aspiration does not have a significant difference (p-value of `r right1_noSRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is also insignificant (p-value of
`r right1_noSRU.beta.permute$tab$"Pr(>F)"[1]`).

#### LefSE
```{r right1_noSRU_generate_lefse, echo=FALSE, results='hide'}
right1_noSRU_lefse.file = file.path(lefse_outdir,"right1_noSRU.tsv")
GenerateLefseOutput(right1_noSRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right1_noSRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right1_noSRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis'}
ShowFigure(paste0(file_path_sans_ext(right1_noSRU_lefse.file), ".png"))
```

Despite the lack of significance from the permanova, LefSE does find one taxon with a significant difference in abundance. Given the permanova results, I am inclinded to discard this result.

## Part 2: Compare Whole Gastric Fluid Cohorts, Right Lung
* Samples
    + WRU1 through 12 (whole gastric fluid, cohort #1)
    + WRU13 through 24 (whole gastric fluid, cohort #2)
* Analysis
    + NMDS plot
    + LEfSe 
    
```{r, echo=FALSE, results = 'asis'}
# subset data
right_lung2_WRU.ps = subset_samples(bacteria.ps, group == "WRU")

# Create cohort variable
sample_data(right_lung2_WRU.ps)$cohort = get_variable(right_lung2_WRU.ps, "animal") %>%
  divide_by_int(13) %>%
  add(1) %>% 
  factor

right_lung2_WRU.pruned.ps = PruneTaxa(right_lung2_WRU.ps)

## Transform to even sampling depth.
right_lung2_WRU.even.ps = TransformCounts(right_lung2_WRU.pruned.ps)
group_var = "cohort"
```
```{r, echo=FALSE, results='hide'}
sample_data(right_lung2_WRU.ps)
```

### NMDS

```{r, echo=FALSE, results='hide'}
right_lung2_WRU.nmds.plot = NMDSPlot(right_lung2_WRU.even.ps, grouping = group_var)
print(right_lung2_WRU.nmds.plot + geom_text(aes(label=animal),hjust=0, vjust=0))
```

It is somewhat difficult to interpret the NMDS comparing the two WRU cohorts. Most of the samples from both groups of animals cluster together pretty well.  However there are a number of cohort #2 samples that do not.  It seems that these may be  aberant samples, although they could indicate larger dispersion in cohort #2.

#### Examine possible outliers

```{r, echo=FALSE, results='hide'}
right_lung2_WRU.ps.rel  = transform_sample_counts(right_lung2_WRU.ps, function(x) x / sum(x) )
right_lung2_WRU.ps.rel.filt = filter_taxa(right_lung2_WRU.ps.rel, function(x) var(x) > 1e-4, TRUE)

right_lung2_WRU.rel.plot = ggplot(psmelt(right_lung2_WRU.ps.rel.filt), 
           aes_string(x = "animal", y = "Abundance", fill = "Genus")) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(~group) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
  theme(legend.key.size = unit(0.5, "cm")) +
  ylab("Relative Abundance")
  # guides(fill=guide_legend(ncol=2))
print(right_lung2_WRU.rel.plot)
```


```{r, echo=FALSE, results='hide'}

right_lung2_WRU.plot = ggplot(psmelt(right_lung2_WRU.ps), 
           aes_string(x = "animal", y = "Abundance", fill = "Genus")) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(~group) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
  theme(legend.key.size = unit(0.5, "cm")) + 
  guides(fill=FALSE) + 
  ylab("Raw Bacterial Counts")
  # guides(fill=guide_legend(ncol=2))
print(right_lung2_WRU.plot )
```

WRU #14, #15, #18, and #19 look like a little different, but do not seem to be extreme outliers.  There does not seem to be a strong justification for excluding them.

### Permanova
```{r, echo=FALSE}
right_lung2_WRU.perm = RunPermanova(right_lung2_WRU.even.ps, group_var)
right_lung2_WRU.adonis = right_lung2_WRU.perm$adonis
print(right_lung2_WRU.adonis)

right_lung2_WRU.beta.permute = right_lung2_WRU.perm$beta
print(right_lung2_WRU.beta.permute)
```

The permanova comparing the right lungs of the two cohorts for the whole gastric fluid aspiration treatment yields a significant difference (p-value of `r right_lung2_WRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_lung2_WRU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the cohorts have different microbial communities.

### LefSE
```{r right_lung2_WRU_generate_lefse, echo=FALSE, results='hide'}
right_lung2_WRU_lefse.file = file.path(lefse_outdir,"right_lung2_WRU.tsv")
GenerateLefseOutput(right_lung2_WRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right_lung2_WRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_lung2_WRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis', eval=FALSE}
ShowFigure(paste0(file_path_sans_ext(right_lung2_WRU_lefse.file), ".png"))
```
Despite a significant permanova, LefSE does not find any taxa that are significantly differentially abundant between the two whole gastric fluid cohorts in the right lung.


As expected for a non-significant permanova, LefSE does not find any taxa that show significantly different abundance.

<!---
Confirmed: No differentially abundant features found in workspace/lefse_aspiration_left_right/right_lung2_WRU.res
-->


## Part 3
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU13 through 24 (whole gastric fluid, cohort #2)
    + WRU13 through 24
    + ASWLU1 through 12 (whole gastric fluid plus antibiotics)
    + ASWRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, SRU and WRU groups
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, WRU and ASWRU groups
        + NMDS plot
        + LEfSe

### Right vs Left Lung
#### SLU vs SRU
> This is a repeat from part 1!

```{r, echo=FALSE, results = 'asis'}
right_left1_SLU_SRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("SLU","SRU")))
right_left1_SLU_SRU.pruned.ps = PruneTaxa(right_left1_SLU_SRU.ps)

## Transform to even sampling depth.
right_left1_SLU_SRU.even.ps = TransformCounts(right_left1_SLU_SRU.pruned.ps)
group_var = "group"
```

##### NMDS
```{r, echo=FALSE, results='hide'}
right_left1_SLU_SRU.nmds.plot = NMDSPlot(right_left1_SLU_SRU.even.ps, grouping = group_var)
print(right_left1_SLU_SRU.nmds.plot)
```

##### Permanova
The ordination plot, suggest that aspiration with saline in the left lung does not significantly effect the microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_SLU_SRU.perm = RunPermanova(right_left1_SLU_SRU.even.ps, group_var)
right_left1_SLU_SRU.adonis = right_left1_SLU_SRU.perm$adonis
print(right_left1_SLU_SRU.adonis)

right_left1_SLU_SRU.beta.permute = right_left1_SLU_SRU.perm$beta
print(right_left1_SLU_SRU.beta.permute)
```

The permanova comparing left lung aspirated with saline to paired, unaspirated right lung does not find a significant difference (p-value of `r right_left1_SLU_SRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is also insignificant (p-value of
`r right_left1_SLU_SRU.beta.permute$tab$"Pr(>F)"[1]`). 

#### WLU vs WRU, cohort #2
```{r, echo=FALSE, results = 'asis'}
right_left3_WLU_WRU_cohort2.ps = subset_samples(bacteria.ps,
                               (group %in% c("WLU","WRU"))
                               & (animal >= 13))

right_left3_WLU_WRU_cohort2.pruned.ps = PruneTaxa(right_left3_WLU_WRU_cohort2.ps)

## Transform to even sampling depth.
right_left3_WLU_WRU_cohort2.even.ps = TransformCounts(right_left3_WLU_WRU_cohort2.pruned.ps)
group_var = "group"
```
```{r, echo=FALSE, results='hide'}
sample_data(right_left3_WLU_WRU_cohort2.ps)
```

##### NMDS
```{r, echo=FALSE, results='hide'}
right_left3_WLU_WRU_cohort2.nmds.plot = NMDSPlot(right_left3_WLU_WRU_cohort2.even.ps, grouping = group_var)
print(right_left3_WLU_WRU_cohort2.nmds.plot)
```

##### Permanova
The ordination plot, suggest that aspiration with whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left3_WLU_WRU_cohort2.perm = RunPermanova(right_left3_WLU_WRU_cohort2.even.ps, group_var)
right_left3_WLU_WRU_cohort2.adonis = right_left3_WLU_WRU_cohort2.perm$adonis
print(right_left3_WLU_WRU_cohort2.adonis)

right_left3_WLU_WRU_cohort2.beta.permute = right_left3_WLU_WRU_cohort2.perm$beta
print(right_left3_WLU_WRU_cohort2.beta.permute)
```

The permanova comparing left lung aspirated with whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right_left3_WLU_WRU_cohort2.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left3_WLU_WRU_cohort2.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

##### LefSE
```{r right_left3_WLU_WRU_cohort2_generate_lefse, echo=FALSE, results='hide'}
right_left3_WLU_WRU_cohort2_lefse.file = file.path(lefse_outdir,"right_left3_WLU_WRU_cohort2.tsv")
GenerateLefseOutput(right_left3_WLU_WRU_cohort2.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right_left3_WLU_WRU_cohort2_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left3_WLU_WRU_cohort2_lefse.file)
```


```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis'}
ShowFigure(paste0(file_path_sans_ext(right_left3_WLU_WRU_cohort2_lefse.file), ".png"))
```


```{r right_left3_WLU_WRU_cohort2_process_lefse, echo=FALSE}
# list.files(paste0(file_path_sans_ext(right_left3_WLU_WRU_cohort2_lefse.file), ".res"))
# list.files(basename(right_left3_WLU_WRU_cohort2_lefse.file))
# 
# list.files(dirname(right_left3_WLU_WRU_cohort2_lefse.file))
# list.files(right_left3_WLU_WRU_cohort2_lefse.file)
# read.delim(right_left3_WLU_WRU_cohort2_lefse.file) %>% head
# 
res.df = paste0(file_path_sans_ext(right_left3_WLU_WRU_cohort2_lefse.file), ".res") %>%
  read.delim(header=FALSE, stringsAsFactors = FALSE,
             col.names= c("taxon","lda_score","class","maybe_lda_threshold", 
                         "maybe_wilcoxon"))
sig.taxon = res.df %>% filter(class != "") %>% select(taxon) %>% as.character 
```

As with cohort #1, WLU vs WRU, cohort #2 also finds a significant difference between lungs aspirated with whole gastric fluid and the untreated right lung from the same animal.  However, the taxa identified as significant are different.  For cohort #2 the significant taxon is an indeterminate genus from the family `r  str_split(sig.taxon, "\\.")[[1]][5]`




#### WLU vs WRU, all
```{r, echo=FALSE, results = 'asis'}
right_left3_WLU_WRU_all.ps = subset_samples(bacteria.ps,
                               group %in% c("WLU","WRU"))

sample_data(right_left3_WLU_WRU_all.ps)$cohort = get_variable(right_left3_WLU_WRU_all.ps, "animal") %>%
  divide_by_int(13) %>%
  add(1) %>% 
  factor

right_left3_WLU_WRU_all.pruned.ps = PruneTaxa(right_left3_WLU_WRU_all.ps)

## Transform to even sampling depth.
right_left3_WLU_WRU_all.even.ps = TransformCounts(right_left3_WLU_WRU_all.pruned.ps)
group_var = "group"
```
```{r, echo=FALSE, results='hide'}
sample_data(right_left3_WLU_WRU_all.ps)
```

##### NMDS
```{r, echo=FALSE, results='hide'}
right_left3_WLU_WRU_all.nmds.plot = NMDSPlot(right_left3_WLU_WRU_all.even.ps, grouping = group_var)
print(right_left3_WLU_WRU_all.nmds.plot + aes(shape=cohort))
```

##### Permanova
The ordination plot, suggest that aspiration with whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left3_WLU_WRU_all.perm = RunPermanova(right_left3_WLU_WRU_all.even.ps, group_var)
right_left3_WLU_WRU_all.adonis = right_left3_WLU_WRU_all.perm$adonis
print(right_left3_WLU_WRU_all.adonis)

right_left3_WLU_WRU_all.beta.permute = right_left3_WLU_WRU_all.perm$beta
print(right_left3_WLU_WRU_all.beta.permute)
```

The permanova comparing left lung aspirated with whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right_left3_WLU_WRU_all.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left3_WLU_WRU_all.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

##### LefSE
```{r right_left3_WLU_WRU_all_generate_lefse, echo=FALSE, results='hide'}
right_left3_WLU_WRU_all_lefse.file = file.path(lefse_outdir,"right_left3_WLU_WRU_all.tsv")
GenerateLefseOutput(right_left3_WLU_WRU_all.pruned.ps, 
                    output_columns = c(group_var,"cohort"),
                    outfile = right_left3_WLU_WRU_all_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left3_WLU_WRU_all_lefse.file)
```


```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -s3 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis', eval=FALSE}
ShowFigure(paste0(file_path_sans_ext(right_left3_WLU_WRU_all_lefse.file), ".png"))
```

As with the separated cohorts, combining them finds a significant difference between between lungs aspirated with whole gastric fluid and the untreated right lung from the same animal.  However, the lefse analysis fails to find taxa with significantly different abundance.

<!---
Confirmed: No differentially abundant features found in workspace/lefse_aspiration_left_right/right_left3_WLU_WRU_all.res
-->

#### ASWLU vs ASWRU
```{r, echo=FALSE, results = 'asis'}
right_left1_ASWLU_ASWRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("ASWLU","ASWRU")))
right_left1_ASWLU_ASWRU.pruned.ps = PruneTaxa(right_left1_ASWLU_ASWRU.ps)

## Transform to even sampling depth.
right_left1_ASWLU_ASWRU.even.ps = TransformCounts(right_left1_ASWLU_ASWRU.pruned.ps)
group_var = "group"
```

##### NMDS
```{r, echo=FALSE, results='hide'}
right_left1_ASWLU_ASWRU.nmds.plot = NMDSPlot(right_left1_ASWLU_ASWRU.even.ps, grouping = group_var)
print(right_left1_ASWLU_ASWRU.nmds.plot)
```

##### Permanova
The ordination plot suggest that, in antibiotic treated animals, aspiration with whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_ASWLU_ASWRU.perm = RunPermanova(right_left1_ASWLU_ASWRU.even.ps, group_var)
right_left1_ASWLU_ASWRU.adonis = right_left1_ASWLU_ASWRU.perm$adonis
print(right_left1_ASWLU_ASWRU.adonis)

right_left1_ASWLU_ASWRU.beta.permute = right_left1_ASWLU_ASWRU.perm$beta
print(right_left1_ASWLU_ASWRU.beta.permute)
```

The permanova comparing left lung aspirated with whole gastric fluid to unaspirated right lung from the same antibiotic treated animal yields a significant difference (p-value of `r right_left1_ASWLU_ASWRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is moderately significant at a p-value of
`r right_left1_ASWLU_ASWRU.beta.permute$tab$"Pr(>F)"[1]`, so the differences identified by the permanova could be due to differences in dispersion.

##### LefSE
```{r right_left1_ASWLU_ASWRU_generate_lefse, echo=FALSE, results='hide'}
right_left1_ASWLU_ASWRU_lefse.file = file.path(lefse_outdir,"right_left1_ASWLU_ASWRU.tsv")
GenerateLefseOutput(right_left1_ASWLU_ASWRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right_left1_ASWLU_ASWRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left1_ASWLU_ASWRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis'}
ShowFigure(paste0(file_path_sans_ext(right_left1_ASWLU_ASWRU_lefse.file), ".png"))
```
Despite a significant permanova, LefSE does not find any taxa that are significantly different between the left lung aspirated with whole gastric fluid and the unaspirated right lung in antibiotic treated animals

<!---
Confirmed: No differentially abundant features found in workspace/lefse_aspiration_left_right/right_left1_ASWLU_ASWRU.res
-->

### Right Lung, Saline vs Whole Gastric cohort #2 (SRU vs WRU 13-24)
```{r, echo=FALSE, results = 'asis'}
right3_SRU_WRU.ps = subset_samples(bacteria.ps, 
                                    ((group == "SRU") |
                                       ((group == "WRU") & (animal >= 13))))

right3_SRU_WRU.pruned.ps = PruneTaxa(right3_SRU_WRU.ps)

## Transform to even sampling depth.
right3_SRU_WRU.even.ps = TransformCounts(right3_SRU_WRU.pruned.ps)
group_var = "group"
```

#### NMDS
```{r, echo=FALSE, results='hide'}
right3_SRU_WRU.nmds.plot = NMDSPlot(right3_SRU_WRU.even.ps, grouping = group_var)
print(right3_SRU_WRU.nmds.plot +geom_text(aes(label=animal),hjust=0, vjust=0))
```

It is difficult to interpret the NMDS comparing the untreated right lungs from animals aspirated with saline vs those aspirated with whole gastric fluid.  We see the same pattern as above comparing the two different WRU cohorts.  Most of the samples from both groups of animals cluster together.  However there are a number of right lung samples from the whole gastric aspirated animals that do not.  It is unclear whether these are aberant samples, or simply indicative of larger dispersion in the whole gastric animals. The permanova and beta-dispersion analysis may shed some light on the issue. 

#### Permanova

```{r, echo=FALSE}
right3_SRU_WRU.perm = RunPermanova(right3_SRU_WRU.even.ps, group_var)
right3_SRU_WRU.adonis = right3_SRU_WRU.perm$adonis
print(right3_SRU_WRU.adonis)

right3_SRU_WRU.beta.permute = right3_SRU_WRU.perm$beta
print(right3_SRU_WRU.beta.permute)
```

The permanova comparing right lung samples by left-lung aspiration does show a significant difference (p-value of `r right3_SRU_WRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right3_SRU_WRU.beta.permute$tab$"Pr(>F)"[1]`).  In light of the outliers in WRU cohort #2, it is difficult to interpret this.

#### LefSE
```{r, echo=FALSE, results='hide'}
right3_SRU_WRU_lefse.file = file.path(lefse_outdir,"right3_SRU_WRU.tsv")
GenerateLefseOutput(right3_SRU_WRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right3_SRU_WRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right3_SRU_WRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis', eval=FALSE}
ShowFigure(paste0(file_path_sans_ext(right3_SRU_WRU_lefse.file), ".png"))
```

<!---
Confirmed: No differentially abundant features found in workspace/lefse_aspiration_left_right/right3_SRU_WRU.res
-->

### Right Lung, Whole Gastric with and without (cohort #2) Antibiotics (WRU 13-24 vs ASWRU)

```{r, echo=FALSE, results = 'asis'}
right3_ASWRU_WRU.ps = subset_samples(bacteria.ps,
                                    ((group == "ASWRU") |
                                       (group == "WRU" & animal >= 13)))

right3_ASWRU_WRU.pruned.ps = PruneTaxa(right3_ASWRU_WRU.ps)

## Transform to even sampling depth.
right3_ASWRU_WRU.even.ps = TransformCounts(right3_ASWRU_WRU.pruned.ps)
group_var = "group"
```

```{r, echo=FALSE, results='hide'}
sample_data(right3_ASWRU_WRU.ps)
```

#### NMDS
```{r, echo=FALSE, results='hide'}
right3_ASWRU_WRU.nmds.plot = NMDSPlot(right3_ASWRU_WRU.even.ps, grouping = group_var)
print(right3_ASWRU_WRU.nmds.plot +geom_text(aes(label=animal),hjust=0, vjust=0))

```

Here we see the same pattern as above comparing the two different WRU cohorts, and comparing SRU with WRU cohort #2.  Most of the samples from both groups of animals cluster together.  However there are a number of right lung samples from the whole gastric aspirated animals that do not; these are the same four aparent outliers as above.  It is still unclear whether these are aberant samples, or simply indicative of larger dispersion in the whole gastric animals, however the fact that they appear to be outliers compared to two groups give greater credence to the possibility that they are aberant samples.

#### Permanova
```{r, echo=FALSE}
right3_ASWRU_WRU.perm = RunPermanova(right3_ASWRU_WRU.even.ps, group_var)
right3_ASWRU_WRU.adonis = right3_ASWRU_WRU.perm$adonis
print(right3_ASWRU_WRU.adonis)

right3_ASWRU_WRU.beta.permute = right3_ASWRU_WRU.perm$beta
print(right3_ASWRU_WRU.beta.permute)
```

The permanova comparing right lung samples by aspiration does not have a significant difference (p-value of `r right3_ASWRU_WRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is also insignificant (p-value of
`r right3_ASWRU_WRU.beta.permute$tab$"Pr(>F)"[1]`).

#### LefSE
```{r, echo=FALSE, results='hide'}
right3_ASWRU_WRU_lefse.file = file.path(lefse_outdir,"right3_ASWRU_WRU.tsv")
GenerateLefseOutput(right3_ASWRU_WRU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right3_ASWRU_WRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right3_ASWRU_WRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis'}
ShowFigure(paste0(file_path_sans_ext(right3_ASWRU_WRU_lefse.file), ".png"))
```

Despite the lack of significance in the permanova, LefSE finds a significant difference in abundance between antibiotic treated and untreated animals in the (unaspirated) right lungs of animals whose left lungs were aspirated with whole gastric fluid.  This difference is in the phylum Bacteroidetes.

# Appendix
## All Lefse Plots
LefSE has the capacity to generate a lot of plots.  I have incorporated the ones that I think are most relevant above, but am including the full set here to give a different perspective on the data, and in case you want more information about any of them.
```{r show_all_pngs, echo=FALSE, results = 'asis'}

for (cur_png in list.files(lefse_outdir, pattern = ".png$",recursive = TRUE,full.names = TRUE)){
  cat(paste0(cur_png,"\n\n\n"))
  ShowFigure(cur_png)
}
```


<!---
COMMENT!
-->


<!---
### Test ShowFigure
-->
```{r, echo=FALSE, include=FALSE, results = 'asis'}
ShowFigure(file.path(lefse_outdir,"no_dummy.png"))

# ShowFigure(file.path(lefse_outdir,"dummy_file.png"),dummy_figure=TRUE)
```
