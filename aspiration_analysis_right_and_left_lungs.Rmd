---
title: "Manuscript 2: Gastric aspiration and the lung microbiome, right and left lungs"
output: 
  html_document:
    toc: true # table of content 
    toc_float:
      collapsed: true
      smooth_scroll: false
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---



```{r load_libraries, echo=FALSE, results='hide'}

source("analysis_functions.R")

## Load Libraries
suppressPackageStartupMessages(library("phyloseq"))
# suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("dplyr"))
# suppressPackageStartupMessages(library("vegan"))
# suppressPackageStartupMessages(library("stringr"))
# suppressPackageStartupMessages(library("tidyr"))
# suppressPackageStartupMessages(library("tibble"))
# suppressPackageStartupMessages(library("magrittr"))
# suppressPackageStartupMessages(library("stringr"))
suppressPackageStartupMessages(library("tools"))

## Load Data
bacteria.ps = readRDS(file.path("workspace", "bacteria_ps.rds"))

## Setup Output
lefse_outdir = file.path("workspace","lefse_aspiration_left_right")
dir.create(lefse_outdir, showWarnings = FALSE)
```

```{r check_metadata, echo=FALSE, results='hide'}
# Figure out how to label plot
sample_data(bacteria.ps) %>% colnames() %>% paste(collapse = ",")

sample_data(bacteria.ps) %>% select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,lung,treated_lung,antibiotic_bool,aspiration_bool) %>% unique

sample_data(bacteria.ps) %>% 
  select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,
         lung,treated_lung,antibiotic_bool,aspiration_bool) %>% 
  unique %>%
  filter(lung=="right")
```

# RIGHT lung PAIRED with LEFT lung from same animal (e.g. SLU1 paired with SRU1) 
## Part 1
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU1 through 12 (whole gastric fluid, group #1)
    + WRU1 through 12
    + ILU1 through 12 (irradiated gastric fluid)
    + IRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only including SRU group, then excluding SRU group
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only excluding SRU group
        + NMDS plot
        + LEfSe

### Right vs Left Lung
#### SLU vs SRU
```{r, echo=FALSE, results = 'asis'}
right_left1_SLU_SRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("SLU","SRU")))
right_left1_SLU_SRU.pruned.ps = PruneTaxa(right_left1_SLU_SRU.ps)

## Transform to even sampling depth.
right_left1_SLU_SRU.even.ps = TransformCounts(right_left1_SLU_SRU.pruned.ps)
```

##### NMDS
```{r, echo=FALSE, results='hide'}
right_left1_SLU_SRU.nmds.plot = NMDSPlot(right_left1_SLU_SRU.even.ps, grouping = "lung")
print(right_left1_SLU_SRU.nmds.plot)
```

##### Permanova
The ordination plot, suggest that aspiration with saline in the left lung does not significantly effect the microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_SLU_SRU.perm = RunPermanova(right_left1_SLU_SRU.even.ps, "lung")
right_left1_SLU_SRU.adonis = right_left1_SLU_SRU.perm$adonis
print(right_left1_SLU_SRU.adonis)

right_left1_SLU_SRU.beta.permute = right_left1_SLU_SRU.perm$beta
print(right_left1_SLU_SRU.beta.permute)
```

The permanova comparing left lung aspirated with saline to paired, unaspirated right lung does not find a significant difference (p-value of `r right_left1_SLU_SRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is also insignificant (p-value of
`r right_left1_SLU_SRU.beta.permute$tab$"Pr(>F)"[1]`). 


#### WLU vs WRU
```{r, echo=FALSE, results = 'asis'}
right_left1_WLU_WRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("WLU","WRU")))
right_left1_WLU_WRU.pruned.ps = PruneTaxa(right_left1_WLU_WRU.ps)

## Transform to even sampling depth.
right_left1_WLU_WRU.even.ps = TransformCounts(right_left1_WLU_WRU.pruned.ps)
```

```{r, echo=FALSE, results='hide'}
right_left1_WLU_WRU.nmds.plot = NMDSPlot(right_left1_WLU_WRU.even.ps, grouping = "lung")
print(right_left1_WLU_WRU.nmds.plot)
```


##### Permanova
The ordination plot, suggest that aspiration with whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_WLU_WRU.perm = RunPermanova(right_left1_WLU_WRU.even.ps, "lung")
right_left1_WLU_WRU.adonis = right_left1_WLU_WRU.perm$adonis
print(right_left1_WLU_WRU.adonis)

right_left1_WLU_WRU.beta.permute = right_left1_WLU_WRU.perm$beta
print(right_left1_WLU_WRU.beta.permute)
```

The permanova comparing left lung aspirated with whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right_left1_WLU_WRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left1_WLU_WRU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

##### LefSE
```{r right_left1_WLU_WRU_generate_lefse, echo=FALSE, results='hide'}
right_left1_WLU_WRU_lefse.file = file.path(lefse_outdir,"right_left1_WLU_WRU.tsv")
GenerateLefseOutput(right_left1_WLU_WRU.pruned.ps, 
                    output_columns = c("lung"),
                    outfile = right_left1_WLU_WRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left1_WLU_WRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis'}
ShowFigure(paste0(file_path_sans_ext(right_left1_WLU_WRU_lefse.file), ".png"))
```

#### ILU vs IRU
```{r, echo=FALSE, results = 'asis'}
right_left1_ILU_IRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("ILU","IRU")))
right_left1_ILU_IRU.pruned.ps = PruneTaxa(right_left1_ILU_IRU.ps)

## Transform to even sampling depth.
right_left1_ILU_IRU.even.ps = TransformCounts(right_left1_ILU_IRU.pruned.ps)
```

```{r, echo=FALSE, results='hide'}
right_left1_ILU_IRU.nmds.plot = NMDSPlot(right_left1_ILU_IRU.even.ps, grouping = "lung")
print(right_left1_ILU_IRU.nmds.plot)
```


##### Permanova
The ordination plot suggest that aspiration with irradiated whole gastric fluid results in a drastic change in microbial community relative to the untreated right lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_ILU_IRU.perm = RunPermanova(right_left1_ILU_IRU.even.ps, "lung")
right_left1_ILU_IRU.adonis = right_left1_ILU_IRU.perm$adonis
print(right_left1_ILU_IRU.adonis)

right_left1_ILU_IRU.beta.permute = right_left1_ILU_IRU.perm$beta
print(right_left1_ILU_IRU.beta.permute)
```

The permanova comparing left lung aspirated with irradiated whole gastric fluid to unaspirated right lung from the same animal yields a significant difference (p-value of `r right_left1_ILU_IRU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left1_ILU_IRU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

##### LefSE
```{r right_left1_ILU_IRU_generate_lefse, echo=FALSE, results='hide'}
right_left1_ILU_IRU_lefse.file = file.path(lefse_outdir,"right_left1_ILU_IRU.tsv")
GenerateLefseOutput(right_left1_ILU_IRU.pruned.ps, 
                    output_columns = c("lung"),
                    outfile = right_left1_ILU_IRU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left1_ILU_IRU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

```{r, echo=FALSE, results = 'asis', eval=FALSE}
ShowFigure(paste0(file_path_sans_ext(right_left1_ILU_IRU_lefse.file), ".png"))
```
Despite a significant permanova, LefSE does not find any taxa that are significantly different between the left lung aspirated with irradiated whole gastric fluid and the unaspirated right lung.

#### ASWLU vs ASWRU

# HERE HERE HERE


## Part 1: Aspiration with Saline,Gastric Fluid, and Irradiated Gastric Fluid


# NOT DONE YET -------------------------------------------------------------------

## Part 2
* Samples
    + WRU1 through 12 (whole gastric fluid, cohort #1)
    + WRU13 through 24 (whole gastric fluid, cohort #2)
* Analysis
    + NMDS plot
    + LEfSe 

## Part 3
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU13 through 24 (whole gastric fluid, cohort #2)
    + WRU13 through 24
    + ASWLU1 through 12 (whole gastric fluid plus antibiotics)
    + ASWRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, SRU and WRU groups
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, WRU and ASWRU groups
        + NMDS plot
        + LEfSe
        
        
# Appendix

## All Lefse Plots
LefSE has the capacity to generate a lot of plots.  I have incorporated the ones that I think are most relevant above, but am including the full set here to give a different perspective on the data, and in case you want more information about any of them.
```{r show_all_pngs, echo=FALSE, results = 'asis'}

for (cur_png in list.files(lefse_outdir, pattern = ".png$",recursive = TRUE,full.names = TRUE)){
  cat(paste0(cur_png,"\n\n\n"))
  ShowFigure(cur_png)
}
```

### Test ShowFigure
```{r, echo=FALSE, include=FALSE, results = 'asis'}
ShowFigure(file.path(lefse_outdir,"no_dummy.png"))

# ShowFigure(file.path(lefse_outdir,"dummy_file.png"),dummy_figure=TRUE)
```
