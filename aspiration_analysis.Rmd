---
title: "Manuscript 2: Gastric aspiration and the lung microbiome"
output: html_document
---
# Setup
```{r, echo=FALSE, results='hide'}
## Load Libraries
suppressPackageStartupMessages(library("phyloseq"))
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("dplyr"))
suppressPackageStartupMessages(library("vegan"))
suppressPackageStartupMessages(library("stringr"))
suppressPackageStartupMessages(library("tidyr"))
suppressPackageStartupMessages(library("tibble"))


## Load Data
bacteria.ps = readRDS(file.path("workspace", "bacteria_ps.rds"))

## Setup Output
lefse_outdir = file.path("workspace","lefse_aspiration")
dir.create(lefse_outdir, showWarnings = FALSE)
```

## Functions
```{r, echo=FALSE}
ShowFigure = function(plotfile, dummy_figure=FALSE){
  # if (!file.exists(plotfile)){
  #   # make a dummy figure if the real one doesn't exist so pandoc doesn't barf
  #   ggplot() + ggtitle(paste("placeholder for:", plotfile))
  #   ggsave(plotfile)
  # }
  if (file.exists(plotfile)){
    fig_markdown = paste0("![](", plotfile, ")")
  } else if (dummy_figure) {
    # make a dummy figure if the real one doesn't exist so pandoc doesn't barf
    ggplot() + ggtitle(paste("placeholder for:", plotfile))
    ggsave(plotfile)
    fig_markdown = paste0("![](", plotfile, ")")
  } else {
    fig_markdown = paste("> Image doesn't exist:", plotfile)
  }
  cat(fig_markdown, fill=TRUE)
}
```


```{r, echo=FALSE}
#' RepseqToTaxa:
#' Convert Repseq column names to Taxa column names in a spread data frame
#' The big problem here is that this needs to be done after all other 
#' manipulations to the dataframe, otherwise most functions will balk if there
#' are dataframe columns with identical names
#'
#' @param spread.df The dataframe generated from phyloseq object.
#' @param source.ps phyloseq object from which spread.df was derived.
RepseqToTaxa <- function(spread.df, source.ps) {
  tax.df = as.data.frame(tax_table(source.ps)) %>%
    rownames_to_column("repseq") %>%
    mutate(taxonomy = paste(Kingdom,Phylum,Class,Order,Family,Genus, sep="|")) %>%
    select(repseq, taxonomy)
  
  # need to preserve non-OTU column names (otherwise they get lost)
  colname_match = match(names(spread.df), tax.df$repseq)
  cols_to_keep = which(is.na(colname_match))
  colnames_to_keep = names(spread.df)[cols_to_keep]
  
  # replace repseqs with taxonomies
  names(spread.df) = tax.df$taxonomy[match(names(spread.df), tax.df$repseq)]
  # now reset the non-OTU column names
  names(spread.df)[cols_to_keep] = colnames_to_keep
  return(spread.df)
}

GenerateLefseOutput = function(ps,output_columns,outfile){
  base_columns = c("SampleID","OTU","Abundance")
  spread.df = psmelt(ps) %>% 
  mutate(SampleID = str_replace(SampleID, pattern="\\.", replacement="_")) %>%
  mutate(taxonomy = paste(Kingdom,Phylum,Class,Order,Family,Genus, sep="|")) %>%
  select(one_of(c(base_columns,output_columns))) %>%
  spread(OTU, Abundance)
  
  RepseqToTaxa(spread.df, ps) %>%
      write.table(file=outfile, 
            sep="\t", quote = FALSE,
            row.names = FALSE)
}
```



```{r, echo=FALSE, results = 'asis'}
ShowFigure(file.path(lefse_outdir,"no_dummy.png"))


ShowFigure(file.path(lefse_outdir,"dummy_file.png"),dummy_figure=TRUE)
```

# LEFT LUNG only
## Part 1
* Samples
    + SLU1 through 11 (control)
    + WLU1 through 12 (whole gastric fluid, group #1)
    + ILU1 through 12 (irradiated gastric fluid)
* Analysis
    + with SLU group
        + NMDS plot
        + LEfSe 
    + **without** SLU group
        + NMDS plot
        + LEfSe 

> Should we include the no-aspiration group to determine if aspiration itself has an effect?

```{r, echo=FALSE, results='hide'}
# subset data
left_lung1.ps = subset_samples(bacteria.ps,
                               group %in% c("SLU", "WLU", "ILU"))
left_lung1.ps = subset_samples(left_lung1.ps, animal %in% seq(1,12))

### Pruning Rare Taxa
min_counts = 2
sample_proportion = 0.01
min_samples = ceiling(sample_proportion*nsamples(left_lung1.ps))
wh0 = genefilter_sample(left_lung1.ps, 
                        filterfun_sample(function(x) x >= min_counts), 
                        A=min_samples)

left_lung1.pruned.ps = prune_taxa(wh0, left_lung1.ps)
```



The data was pruned before ordination to remove rare taxa. To be included in the pruned dataset, a taxon must occur at least `r min_counts` times in at least `r sample_proportion*100`% of samples (`r min_samples` samples). 

Before pruning there are `r ntaxa(left_lung1.ps)` taxa, after pruning there are `r ntaxa(left_lung1.pruned.ps)` taxa remaining.

```{r, echo=FALSE, results='hide'}
# Figure out how to label plot
sample_data(left_lung1.ps) %>% colnames() %>% paste(collapse = ",")

sample_data(left_lung1.ps) %>% select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,lung,treated_lung,antibiotic_bool,aspiration_bool) %>% unique
```
### With Saline Samples
#### NMDS
```{r, echo=FALSE, results='hide'}
## Check if any rows are all zero, because transform_sample_counts will generate NaNs from these
## which (apply(otu_table(left_lung1.pruned.ps), 1, function(row) all(row ==0 )))
## Transform to even sampling depth.
left_lung1.even.ps = transform_sample_counts(left_lung1.pruned.ps, function(x) 1E6 * x/sum(x))

## Remove samples with NaN (samples with all zero rows generate NaN when transformed above because of division by zero)
left_lung1.even.ps = prune_samples(complete.cases(otu_table(left_lung1.even.ps)),left_lung1.even.ps)

set.seed(1)
left_lung1.even.nmds <- ordinate(left_lung1.even.ps, "NMDS", "bray")
left_lung1.even.nmds.plot = plot_ordination(left_lung1.even.ps, left_lung1.even.nmds, type="samples")
ggplot(left_lung1.even.nmds.plot$data, aes(NMDS1, NMDS2)) +
  theme_classic() +
  geom_point(aes(color = sample_aspiration)) +
  annotate("text",x=-Inf,y=-Inf,hjust=0,vjust=0,
           label= paste("Stress:", left_lung1.even.nmds$stress, 
                        "\nConverged:", left_lung1.even.nmds$converged))
```

- **Stress:** `r left_lung1.even.nmds$stress`
- **Converged:** `r left_lung1.even.nmds$converged`

#### Permanova
The ordination plot, suggest that aspiration treatment effects microbial community. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
left_lung1.even.otus <- otu_table(left_lung1.even.ps)
left_lung1.even.bray <- vegdist(left_lung1.even.otus, method="bray")
left_lung1.adonis = adonis(left_lung1.even.bray ~ sample_data(left_lung1.even.ps)$sample_aspiration)
print(left_lung1.adonis)
```
The permanova comparing all modes of aspiration finds a significant difference with a p-value of `r left_lung1.adonis$aov.tab$"Pr(>F)"[1]`. However, the permanova test is sensitive to differences in dispersion between the two groups, so we need to test for homogeneity of dispersion to examine whether differences in dispersion could lead us to falsely conclude that aspriation treatment results in a signifcant differences between the groups. 

```{r, echo=FALSE}
left_lung1.beta <- betadisper(left_lung1.even.bray, sample_data(left_lung1.even.ps)$sample_aspiration)
left_lung1.beta.permute = permutest(left_lung1.beta)
print(left_lung1.beta.permute)
```

The test for test for homogeneity of dispersions yields a **significant** p-value of `r left_lung1.beta.permute$tab$"Pr(>F)"[1]`.  This is not necessarily surprising, because in the NMDS plots the Saline samples seems more tightly clustered than the Gastric samples.  This does **not** mean that we must discard the significant result of the permanova, but we should keep in mind that differences in dispersion are a possible explanation for the permanova result.

#### LefSE
```{r left_lung1_generate_lefse}
left_lung1.lefse.file = file.path(lefse_outdir,"left_lung1_aspiration.tsv")
GenerateLefseOutput(left_lung1.pruned.ps, 
                    output_columns = c("sample_aspiration"),
                    outfile = left_lung1.lefse.file
)

Sys.setenv(LEFSE_INPUT_FILE = left_lung1.lefse.file)
```

```{bash}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"

# format_input.py convert the input data matrix to the format for LEfSe.
#
# In this example we use the class information in the first line (-c 1)
# the subclass in the second line (-s 2) and the subject in the third (-u 3).
# If the subclass or the subject are not present in the data you need to set
# the value -1 for them.
# -o 1000000 scales the feature such that the sum (of the same taxonomic leve)
# is 1M: this is done only for obtaining more meaningful values for the LDA score

lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
```

left_lung1.pruned.ps
# GenerateLefseOutput = function(ps,output_columns,outfile){

```{r, echo=FALSE, results = 'asis'}
ShowFigure(file.path(lefse_outdir,"left_lung1_aspiration.png"))
```

### Without Saline Samples
#### NMDS
```{r, echo=FALSE, results='hide'}
## Drop "saline" samples
left_lung1_no_saline.pruned.ps = subset_samples(left_lung1.pruned.ps,group %in% c("WLU", "ILU"))

## Check if any rows are all zero, because transform_sample_counts will generate NaNs from these
## which (apply(otu_table(left_lung1.pruned.ps), 1, function(row) all(row ==0 )))
## Transform to even sampling depth.
left_lung1_no_saline.even.ps = transform_sample_counts(left_lung1_no_saline.pruned.ps, function(x) 1E6 * x/sum(x))

## Remove samples with NaN (samples with all zero rows generate NaN when transformed above because of division by zero)
left_lung1_no_saline.even.ps = prune_samples(complete.cases(otu_table(left_lung1_no_saline.even.ps)),left_lung1_no_saline.even.ps)

set.seed(1)
left_lung1_no_saline.even.nmds <- ordinate(left_lung1_no_saline.even.ps, "NMDS", "bray")
left_lung1_no_saline.even.nmds.plot = plot_ordination(left_lung1_no_saline.even.ps, left_lung1_no_saline.even.nmds, type="samples")
ggplot(left_lung1_no_saline.even.nmds.plot$data, aes(NMDS1, NMDS2)) +
  theme_classic() +
  geom_point(aes(color = sample_aspiration)) +
  annotate("text",x=-Inf,y=-Inf,hjust=0,vjust=0,
           label= paste("Stress:", left_lung1_no_saline.even.nmds$stress, 
                        "\nConverged:", left_lung1_no_saline.even.nmds$converged))
```

- **Stress:** `r left_lung1_no_saline.even.nmds$stress`
- **Converged:** `r left_lung1_no_saline.even.nmds$converged`

#### Permanova
The ordination plot, suggest that aspiration treatment effects microbial community. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
left_lung1_no_saline.even.otus <- otu_table(left_lung1_no_saline.even.ps)
left_lung1_no_saline.even.bray <- vegdist(left_lung1_no_saline.even.otus, method="bray")
left_lung1_no_saline.adonis = adonis(left_lung1_no_saline.even.bray ~ sample_data(left_lung1_no_saline.even.ps)$sample_aspiration)
print(left_lung1_no_saline.adonis)
```
The permanova comparing aspiration of whole gastric fluid with irradiated gastric does not find a significant difference (p-value of `r left_lung1_no_saline.adonis$aov.tab$"Pr(>F)"[1]`). 
```{r, echo=FALSE}
left_lung1_no_saline.beta <- betadisper(left_lung1_no_saline.even.bray, sample_data(left_lung1_no_saline.even.ps)$sample_aspiration)
left_lung1_no_saline.beta.permute = permutest(left_lung1_no_saline.beta)
print(left_lung1_no_saline.beta.permute)
```

The test for test for homogeneity of dispersions yields a slightly significant p-value of `r left_lung1_no_saline.beta.permute$tab$"Pr(>F)"[1]`.

# NOT DONE YET
## Part 2
* Samples
    + WLU1 through 12 (whole gastric fluid, cohort #1)
    + WLU13 through 24 (whole gastric fluid, cohort #2)
* Analysis
    + NMDS plot
    + LEfSe

## Part 3
* Samples
    + SLU1 through 11 (control)
    + WLU13 through 24 (whole gastric fluid, cohort #2)
    + ASWLU1 through 12 (whole gastric fluid plus antibiotics)
* Analysis
    + SLU and WLU
        + NMDS plot
        + LEfSe 
    + WLU and ASWLU
        + NMDS plot
        + LEfSe 

# RIGHT lung PAIRED with LEFT lung from same animal (e.g. SLU1 paired with SRU1) 
## Part 1
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU1 through 12 (whole gastric fluid, group #1)
    + WRU1 through 12
    + ILU1 through 12 (irradiated gastric fluid)
    + IRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only including SRU group, then excluding SRU group
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only excluding SRU group
        + NMDS plot
        + LEfSe

## Part 2
* Samples
    + WRU1 through 12 (whole gastric fluid, cohort #1)
    + WRU13 through 24 (whole gastric fluid, cohort #2)
* Analysis
    + NMDS plot
    + LEfSe 

## Part 3
* Samples
    + SLU1 through 11 (control)
    + SRU1 through 11
    + WLU13 through 24 (whole gastric fluid, cohort #2)
    + WRU13 through 24
    + ASWLU1 through 12 (whole gastric fluid plus antibiotics)
    + ASWRU1 through 12
* Analysis
    + For each right and left lung PAIR (e.g. SLU1 and SRU1)
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, SRU and WRU groups
        + NMDS plot
        + LEfSe
    + For RIGHT LUNG samples only, WRU and ASWRU groups
        + NMDS plot
        + LEfSe
        
# Appendix
## Testing

## Session Info
```{r}
sessionInfo()
```
