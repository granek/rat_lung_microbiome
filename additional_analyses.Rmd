---
title: "Manuscript 2: Gastric aspiration and the lung microbiome, additional analyses"
output: 
  html_document:
    toc: true # table of content 
    toc_float:
      collapsed: true
      smooth_scroll: false
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---

<!---
From commandline run with the following:
Rscript -e "library(knitr); rmarkdown::render('aspiration_analysis_right_and_left_lungs.Rmd')"
-->

```{r load_libraries, echo=FALSE, results='hide'}

source("analysis_functions.R")

## Load Libraries
suppressPackageStartupMessages(library("phyloseq"))
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("dplyr"))
# suppressPackageStartupMessages(library("vegan"))
# suppressPackageStartupMessages(library("stringr"))
# suppressPackageStartupMessages(library("tidyr"))
# suppressPackageStartupMessages(library("tibble"))
suppressPackageStartupMessages(library("magrittr"))
# suppressPackageStartupMessages(library("stringr"))
suppressPackageStartupMessages(library("tools"))

## Load Data
bacteria_ps.rds = file.path("workspace", "bacteria_ps.rds")
if (!file.exists(bacteria_ps.rds)){
  source("preprocess_phyloseq.R")
}
bacteria.ps = readRDS(bacteria_ps.rds)

## Setup Output
lefse_outdir = file.path("workspace","lefse_aspiration_left_right")
dir.create(lefse_outdir, showWarnings = FALSE)
```

```{r check_metadata, echo=FALSE, results='hide', eval=FALSE}
# Figure out how to label plot
sample_data(bacteria.ps) %>% colnames() %>% paste(collapse = ",")

sample_data(bacteria.ps) %>% select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,lung,treated_lung,antibiotic_bool,aspiration_bool) %>% unique

sample_data(bacteria.ps) %>% 
  select(group,antibiotic,left_aspiration,right_aspiration,sample_aspiration,
         lung,treated_lung,antibiotic_bool,aspiration_bool) %>% 
  unique %>%
  filter(lung=="right")
```

# No treatment comparisons lung Analyses
* Samples
    + NLU
    + SRU
    + WLU (animals 1 to 11)
* Analysis
    + NLU vs SRU
        + NMDS plot
        + LEfSe
    + NLU vs WLU 1-11
        + NMDS plot
        + LEfSe

## Untreated Left vs Saline Right (untreated side)
### NLU vs SRU
```{r, echo=FALSE, results = 'asis'}
right_left1_NLU_SRU.ps = subset_samples(bacteria.ps,
                               (group %in% c("NLU","SRU")))
right_left1_NLU_SRU.pruned.ps = PruneTaxa(right_left1_NLU_SRU.ps)

## Transform to even sampling depth.
right_left1_NLU_SRU.even.ps = TransformCounts(right_left1_NLU_SRU.pruned.ps)
group_var = "group"
```

#### NMDS
```{r, echo=FALSE, results='hide'}
right_left1_NLU_SRU.nmds.plot = NMDSPlot(right_left1_NLU_SRU.even.ps, grouping = group_var)
print(right_left1_NLU_SRU.nmds.plot)
```

#### Permanova
The ordination plot suggest that the unaspirated (control) left lung does not have a significantly different microbial community relative to the unaspirated right lung from a saline aspirated animal. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_NLU_SRU.perm = RunPermanova(right_left1_NLU_SRU.even.ps, group_var)
right_left1_NLU_SRU.adonis = right_left1_NLU_SRU.perm$adonis
print(right_left1_NLU_SRU.adonis)

right_left1_NLU_SRU.beta.permute = right_left1_NLU_SRU.perm$beta
print(right_left1_NLU_SRU.beta.permute)
```

The permanova comparing unaspirated (control) left lung to unaspirated right lung from saline aspirated animal does find a *significant* difference (p-value of `r right_left1_NLU_SRU.adonis$aov.tab$"Pr(>F)"[1]`). 
However, the test for homogeneity of dispersions is also *significant* (p-value of
`r right_left1_NLU_SRU.beta.permute$tab$"Pr(>F)"[1]`), so the permanova results could be due to differences in dispersion.

### NLU vs WLU, cohort #1
```{r, echo=FALSE, results = 'asis'}
right_left1_NLU_WLU.ps = subset_samples(bacteria.ps,
                                        ((group == "WLU") & (animal <= 12)) |
                                          (group == "NLU"))

right_left1_NLU_WLU.pruned.ps = PruneTaxa(right_left1_NLU_WLU.ps)

## Transform to even sampling depth.
right_left1_NLU_WLU.even.ps = TransformCounts(right_left1_NLU_WLU.pruned.ps)
group_var = "group"
```
```{r, echo=FALSE, results='hide'}
sample_data(right_left1_NLU_WLU.ps)
```

```{r, echo=FALSE, results='hide'}
right_left1_NLU_WLU.nmds.plot = NMDSPlot(right_left1_NLU_WLU.even.ps, grouping = group_var)
print(right_left1_NLU_WLU.nmds.plot)
```


#### Permanova
The ordination plot suggest that the unaspirated (control) left lung does not have a significantly different microbial community relative to the unaspirated right lung from a saline aspirated animal. A permanova analysis allows us to quantify this. 



The ordination plot strongly indicates that aspiration with whole gastric fluid results in a drastic change in microbial community relative to the unaspirated (control) left lung. A permanova analysis allows us to quantify this. 

```{r, echo=FALSE}
right_left1_NLU_WLU.perm = RunPermanova(right_left1_NLU_WLU.even.ps, group_var)
right_left1_NLU_WLU.adonis = right_left1_NLU_WLU.perm$adonis
print(right_left1_NLU_WLU.adonis)

right_left1_NLU_WLU.beta.permute = right_left1_NLU_WLU.perm$beta
print(right_left1_NLU_WLU.beta.permute)
```

The permanova comparing left lung aspirated with whole gastric fluid to unaspirated left lungs from control animals yields a significant difference (p-value of `r right_left1_NLU_WLU.adonis$aov.tab$"Pr(>F)"[1]`). 
The test for homogeneity of dispersions is insignificant (p-value of
`r right_left1_NLU_WLU.beta.permute$tab$"Pr(>F)"[1]`), providing strong evidence that the aspiration treatment is altering the microbial community.

#### LefSE
```{r right_left1_NLU_WLU_generate_lefse, echo=FALSE, results='hide'}
right_left1_NLU_WLU_lefse.file = file.path(lefse_outdir,"right_left1_NLU_WLU.tsv")
GenerateLefseOutput(right_left1_NLU_WLU.pruned.ps, 
                    output_columns = c(group_var),
                    outfile = right_left1_NLU_WLU_lefse.file)

Sys.setenv(LEFSE_INPUT_FILE = right_left1_NLU_WLU_lefse.file)
```

```{bash, echo=FALSE, results='hide'}
source /opt/conda/bin/activate qiime1

BASENAME="${LEFSE_INPUT_FILE%.*}"
lefse-format_input.py $LEFSE_INPUT_FILE  "${BASENAME}.in" -f c -u 1 -c 2 -o 1000000  --output_table ${BASENAME}.tab
R_HOME="/opt/conda/envs/qiime1/lib64/R"
bash run_lefse.sh ${BASENAME}.in
```

```{r, echo=FALSE, results = 'asis'}
ShowFigure(paste0(file_path_sans_ext(right_left1_NLU_WLU_lefse.file), ".png"))
```

LefSE identifies a few taxa with significantly differential abundance between left lung aspirated with whole gastric fluid to unaspirated right lung from the same animal.


# Appendix
## All Lefse Plots
LefSE has the capacity to generate a lot of plots.  I have incorporated the ones that I think are most relevant above, but am including the full set here to give a different perspective on the data, and in case you want more information about any of them.
```{r show_all_pngs, echo=FALSE, results = 'asis'}

for (cur_png in list.files(lefse_outdir, pattern = ".png$",recursive = TRUE,full.names = TRUE)){
  cat(paste0(cur_png,"\n\n\n"))
  ShowFigure(cur_png)
}
```


<!---
COMMENT!
-->


<!---
### Test ShowFigure
-->
```{r eval=FALSE, include=FALSE, results=}
ShowFigure(file.path(lefse_outdir,"no_dummy.png"))

# ShowFigure(file.path(lefse_outdir,"dummy_file.png"),dummy_figure=TRUE)
```
