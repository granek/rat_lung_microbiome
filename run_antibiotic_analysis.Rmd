---
title: "Antibiotic Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
file.path()
```

# Preparation
1. Run `preliminary_analyisis.R` first to generate `antibiotic_ps.rds`. (Might want to split that out into a separate file that can be run here.
)
2. Run `antibiotic_run_lefse.sh` which:
    1. runs `antibiotic_for_lefse.R` to reformat data in lefse format
    2. runs lefse and generates figures

## Load Libraries
```{r}
suppressPackageStartupMessages(library("phyloseq"))
suppressPackageStartupMessages(library("ggplot2"))
```

## Load Antibiotic Data
```{r}
antibiotic.rds = "workspace/antibiotic_ps.rds"
antibiotic.ps = readRDS(antibiotic.rds)

```

# Alpha Diversity Plots
```{r}
alpha_plot = plot_richness(antibiotic.ps, x = "antibiotic", 
                           measures = c("Chao1", "ACE", "Shannon", "InvSimpson"), nrow=NULL) + 
  geom_boxplot() + 
  theme(panel.background = element_blank(), 
        axis.text.x  = element_text(angle=0,hjust=0.5))
# ggsave(file=file.path(figure_dir,"max_rep_alpha_diversity.pdf"))
print(alpha_plot)
```
# Relative Abundance Plot
```{r}
antibiotic.ps.rel  = transform_sample_counts(antibiotic.ps, function(x) x / sum(x) )
antibiotic.ps.rel.filt = filter_taxa(antibiotic.ps.rel, function(x) var(x) > 1e-3, TRUE)

antibiotic.rel.plot = ggplot(psmelt(subset_samples(antibiotic.ps.rel.filt,lung=="left")), 
           aes_string(x = "animal", y = "Abundance", fill = "Genus")) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(~antibiotic) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0))
print(antibiotic.rel.plot)
```

# LefSE
## With and Without Antibiotic
If we compare the "no antibiotic" treatment to all "antibiotic" treatments combined (still accounting for mode of administration), we see that two genera of Enterobacteriaceae distinguish them.

![Effect of antibiotic](workspace/lefse/antibiotic_bool.png)

*Serratia* is present in most of the "no-antibiotic" samples, but is not observed in any of the antibiotic treated samples.

![This is workspace/lefse/antibiotic_bool_biomarkers_raw_images/1_Bacteria-Proteobacteria-Gammaproteobacteria-Enterobacteriales-Enterobacteriaceae-Serratia.png](workspace/lefse/antibiotic_bool_biomarkers_raw_images/1_Bacteria-Proteobacteria-Gammaproteobacteria-Enterobacteriales-Enterobacteriaceae-Serratia.png)

*Pantoea* shows the opposite pattern: not observed in most "no-antibiotic" samples, and present in almost all samples form antibiotic treated animals

![This is workspace/lefse/antibiotic_bool_biomarkers_raw_images/1_Bacteria-Proteobacteria-Gammaproteobacteria-Enterobacteriales-Enterobacteriaceae-Pantoea.png](workspace/lefse/antibiotic_bool_biomarkers_raw_images/1_Bacteria-Proteobacteria-Gammaproteobacteria-Enterobacteriales-Enterobacteriaceae-Pantoea.png)

## Antibiotic Subclass Analysis
We can break out the individual modes of antibiotic administration to look for differences.  We find a weaker signal that seems to indicate there may be subtle differences.
![This is workspace/lefse/antibiotic_factor.png](workspace/lefse/antibiotic_factor.png)

### Subcutaneous enrichment
Some **subcutaneous** samples are enriched in *Caulobacter*, with some enrichment in **IV**.
![This is workspace/lefse/antibiotic_factor_biomarkers_raw_images/1_Bacteria-Proteobacteria-Alphaproteobacteria-Caulobacterales-Caulobacteraceae-Caulobacter.png](workspace/lefse/antibiotic_factor_biomarkers_raw_images/1_Bacteria-Proteobacteria-Alphaproteobacteria-Caulobacterales-Caulobacteraceae-Caulobacter.png)

### IV enrichment

A few of the **IV** administered animals have a small enrichment of *Rhodobacteraceae*, although the small number of samples and degree of enrichment make this suspect.
![This is workspace/lefse/antibiotic_factor_biomarkers_raw_images/1_Bacteria-Proteobacteria-Alphaproteobacteria-Rhodobacterales-Rhodobacteraceae.png](workspace/lefse/antibiotic_factor_biomarkers_raw_images/1_Bacteria-Proteobacteria-Alphaproteobacteria-Rhodobacterales-Rhodobacteraceae.png)


```{r show_all_pngs, include = F, results = 'asis'}
# All Plots
lefse_dir="workspace/lefse"
for (cur_png in list.files(lefse_dir, pattern = ".png$",recursive = TRUE,full.names = TRUE)){
  md_string = paste0("![This is ", cur_png,"](", cur_png, ")\n")
  cat(md_string, fill=TRUE)
}
```
